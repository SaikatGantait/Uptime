// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model User {
  id              String      @id     @default(uuid())
  email           String
}

model Website {
  id                  String          @id @default(uuid())
  url                 String
  userId              String
  ticks               WebsiteTick[]
  incidents           Incident[]
  disabled            Boolean         @default(false)
  cooldownMinutes     Int             @default(10)
  retries             Int             @default(2)
  quorum              Int             @default(2)
  validatorsPerRound  Int             @default(3)
  escalationMinutes   Int             @default(5)
  statusPageSlug      String?
  statusPagePublic    Boolean         @default(false)
  statusPageTitle     String          @default("Service Status")
  statusPageLogoUrl   String?
  statusPageBrandColor String?
  lastAlertSentAt     DateTime?
  snoozeUntil         DateTime?
  maintenanceStartAt  DateTime?
  maintenanceEndAt    DateTime?
  checkType           CheckType       @default(HTTP)
  expectedKeyword     String?
  dnsRecordType       String?
  dnsExpectedValue    String?
  tlsWarningDaysCsv   String          @default("30,14,7")
  multiStepConfig     String?
  sloTarget           Float           @default(99.9)
  errorBudgetWindowMinutes Int        @default(43200)
  teamName            String          @default("default")
  alertRoutes         AlertRoute[]
  onCallSchedules     OnCallSchedule[]
  integrations        IntegrationChannel[]
  components          WebsiteComponent[]
  componentTicks      ComponentTick[]
}

model Validator {
  id        String      @id     @default(uuid())
  publicKey String
  location  String
  ip        String
  pendingPayouts  Int         @default(0)
  ticks     WebsiteTick[]
  componentTicks ComponentTick[]
}

model WebsiteComponent {
  id                String          @id @default(uuid())
  websiteId         String
  name              String
  targetUrl         String?
  path              String?
  checkType         CheckType       @default(HTTP)
  expectedKeyword   String?
  dnsRecordType     String?
  dnsExpectedValue  String?
  tlsWarningDaysCsv String?
  multiStepConfig   String?
  enabled           Boolean         @default(true)
  createdAt         DateTime        @default(now())
  website           Website         @relation(fields: [websiteId], references: [id])
  ticks             ComponentTick[]
}

model ComponentTick {
  id           String         @id @default(uuid())
  websiteId    String
  componentId  String
  validatorId  String
  createdAt    DateTime
  status       WebsiteStatus
  latency      Float
  severity     AlertSeverity  @default(P3)
  details      String?
  website      Website        @relation(fields: [websiteId], references: [id])
  component    WebsiteComponent @relation(fields: [componentId], references: [id])
  validator    Validator      @relation(fields: [validatorId], references: [id])
}

model WebsiteTick {
  id         String        @id @default(uuid())
  websiteId  String
  validatorId String
  createdAt  DateTime
  status     WebsiteStatus
  latency    Float
  severity   AlertSeverity  @default(P3)
  details    String?
  website    Website       @relation(fields: [websiteId], references: [id])
  validator  Validator     @relation(fields: [validatorId], references: [id])
}

model Incident {
  id                String          @id @default(uuid())
  websiteId         String
  status            IncidentStatus  @default(OPEN)
  startedAt         DateTime        @default(now())
  resolvedAt        DateTime?
  acknowledgedAt    DateTime?
  escalatedAt       DateTime?
  summary           String?
  postmortemTemplate String?
  severity          AlertSeverity    @default(P3)
  website           Website         @relation(fields: [websiteId], references: [id])
  events            IncidentEvent[]
  deliveries        AlertDelivery[]
}

model IncidentEvent {
  id          String            @id @default(uuid())
  incidentId  String
  createdAt   DateTime          @default(now())
  type        IncidentEventType
  message     String
  incident    Incident          @relation(fields: [incidentId], references: [id])
}

model AlertRoute {
  id            String      @id @default(uuid())
  websiteId     String
  targetTeam    String
  escalationTargetTeam String?
  escalationAfterMinutes Int  @default(10)
  minSeverity   AlertSeverity @default(P3)
  channel       IntegrationType @default(WEBHOOK)
  createdAt     DateTime    @default(now())
  website       Website     @relation(fields: [websiteId], references: [id])
}

model OnCallSchedule {
  id              String      @id @default(uuid())
  websiteId       String
  rotationName    String
  timezone        String      @default("UTC")
  quietHoursStart Int?
  quietHoursEnd   Int?
  createdAt       DateTime    @default(now())
  website         Website     @relation(fields: [websiteId], references: [id])
}

model IntegrationChannel {
  id            String          @id @default(uuid())
  websiteId     String
  type          IntegrationType
  endpoint      String
  enabled       Boolean         @default(true)
  createdAt     DateTime        @default(now())
  website       Website         @relation(fields: [websiteId], references: [id])
}

model AlertDelivery {
  id             String          @id @default(uuid())
  incidentId     String
  channelType    IntegrationType
  destination    String
  status         String
  notificationKind String        @default("FIRE")
  attempts       Int             @default(0)
  maxAttempts    Int             @default(5)
  nextRetryAt    DateTime        @default(now())
  sentAt         DateTime?
  lastError      String?
  externalId     String?
  payload        String?
  createdAt      DateTime        @default(now())
  incident       Incident        @relation(fields: [incidentId], references: [id])
}

enum WebsiteStatus {
  Good
  Bad
}

enum CheckType {
  HTTP
  MULTI_STEP
  KEYWORD
  DNS
  TLS
}

enum AlertSeverity {
  P1
  P2
  P3
}

enum IntegrationType {
  EMAIL
  SMS
  WEBHOOK
  SLACK
  DISCORD
  TEAMS
  PAGERDUTY
  OPSGENIE
}

enum IncidentStatus {
  OPEN
  RESOLVED
}

enum IncidentEventType {
  DETECTED
  ALERT_SENT
  ALERT_SUPPRESSED
  RETRY_ATTEMPT
  QUORUM_DECISION
  ACKNOWLEDGED
  ESCALATED
  RECOVERY
  NOTE
}